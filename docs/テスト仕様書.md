# stapla テスト仕様書

## 1. 概要

| 項目 | 内容 |
|------|------|
| 対象システム | stapla（資格試験の学習計画管理アプリ） |
| バージョン | - |
| 作成日 | 2026-02-18 |
| 技術スタック | Laravel 12, Jetstream, Livewire, LINE Messaging API |

### 1.1 アプリの主な機能

- **認証**: メール登録・ログイン、メール認証、二要素認証
- **設定**: プロフィール、パスワード変更、LINE連携、通知設定、アカウント削除
- **資格管理**: 資格・ドメイン・サブドメインのマスタ管理（管理画面）
- **学習計画**: ドメイン登録、サブドメイン登録、リスケジュール
- **カレンダー**: 月表示・週表示での学習予定表示
- **学習進捗**: 進捗一覧
- **学習記録**: TODO単位の実績登録
- **LINE**: Webhook、友だち追加/解除、連携コード、朝夕のリマインド
- **管理画面**: 資格CRUD、バックアップ、ユーザー管理

---

## 2. テスト種別とスコープ

| 種別 | 対象 | 備考 |
|------|------|------|
| 単体テスト | モデル、サービス、バリデーションロジック | PHPUnit / Pest |
| 機能テスト | HTTPリクエスト〜レスポンス、DB更新 | Feature Test |
| E2Eテスト | ブラウザ操作（任意） | Laravel Dusk 等 |
| 結合テスト | LINE Webhook、Cron 等 | モック／スタブ推奨 |

---

## 3. テストケース一覧

### 3.1 認証

| No | テスト項目 | 前提条件 | 操作 | 期待結果 | 優先度 |
|----|-----------|----------|------|----------|--------|
| AUTH-001 | 未ログインでトップアクセス | - | GET / | ログイン画面へリダイレクト | 高 |
| AUTH-002 | ログイン済みでトップアクセス | ログイン済み | GET / | /home へリダイレクト | 高 |
| AUTH-003 | メールアドレスでログイン | 登録済みユーザー | 正しいメール・パスワードでPOST | ログイン成功、/homeへ | 高 |
| AUTH-004 | 間違ったパスワードでログイン | 登録済みユーザー | 誤ったパスワードでPOST | エラー、ログイン画面に留まる | 高 |
| AUTH-005 | メール内ワンクリックログイン | 署名付きURL、24時間以内 | GET /login-via-email/{user}（有効署名） | ログイン成功 | 中 |
| AUTH-006 | 無効署名のワンクリックログイン | - | GET /login-via-email/{user}（無効署名） | 403 エラー | 中 |
| AUTH-007 | 未ログインで認証必須ページアクセス | - | GET /home, /settings 等 | ログイン画面へリダイレクト | 高 |

---

### 3.2 設定（Settings）

| No | テスト項目 | 前提条件 | 操作 | 期待結果 | 優先度 |
|----|-----------|----------|------|----------|--------|
| SET-001 | 設定ページ表示 | ログイン済み | GET /settings | 設定画面が表示される | 高 |
| SET-002 | LINE連携コード発行 | ログイン済み | POST /settings/line-link | 8桁連携コードが発行され、セッションに保持 | 高 |
| SET-003 | 通知設定更新 | ログイン済み | PUT /settings/notifications（line_morning_at, line_evening_at, line_notify_enabled） | DBに保存、エラーなし | 高 |
| SET-004 | 通知時間フォーマット不正 | ログイン済み | line_morning_at が "25:00" など不正 | 422 バリデーションエラー | 中 |
| SET-005 | 基本情報更新 | ログイン済み | PUT /settings/basic（name, email） | プロフィールが更新される | 高 |
| SET-006 | パスワード更新 | ログイン済み | PUT /settings/password（正しい current_password） | パスワードが更新される | 高 |
| SET-007 | パスワード更新（現在パスワード不一致） | ログイン済み | PUT /settings/password（誤った current_password） | 422 エラー | 中 |
| SET-008 | アカウント削除 | ログイン済み | DELETE /settings/account（パスワード確認） | アカウントが削除されログアウト | 高 |

---

### 3.3 学習計画（Plan Register）

| No | テスト項目 | 前提条件 | 操作 | 期待結果 | 優先度 |
|----|-----------|----------|------|----------|--------|
| PLAN-001 | ドメイン登録（正常） | ログイン済み、資格・ドメインが存在 | POST /plan-register/domain（start_date, exam_date, daily_study_time, buffer_rate, domains, no_study_days） | study_plans_id が返却、Todo・StudyPlanItem が作成される | 高 |
| PLAN-002 | 試験日が開始日以前 | 同上 | exam_date <= start_date で登録 | 422「学習期間が確保できません」 | 高 |
| PLAN-003 | 資格3件超の登録 | 既に3資格をターゲット登録済み | 4件目の資格で登録 | 422「計画は3件までしか登録できません」 | 高 |
| PLAN-004 | 勉強不可日で学習可能日0 | start_date〜exam_date-1 がすべて不可日 | 登録 | 422「学習可能日がありません」 | 中 |
| PLAN-005 | サブドメイン登録 | ログイン済み、ドメイン登録済み | POST /plan-register/subdomain | 計画にサブドメインが紐づく | 高 |
| PLAN-006 | 未認証での計画登録 | 未ログイン | POST /plan-register/domain | 401 または ログインリダイレクト | 高 |

---

### 3.4 リスケジュール（Plan Reschedule）

| No | テスト項目 | 前提条件 | 操作 | 期待結果 | 優先度 |
|----|-----------|----------|------|----------|--------|
| RSCH-001 | リスケデータ取得 | ログイン済み、有効な計画あり | GET /plan-reschedule/target?target_id={id} | target_id, start_date, exam_date, weights 等が返却 | 高 |
| RSCH-002 | 他人の target_id で取得 | 他ユーザーの target | GET /plan-reschedule/target?target_id={他ユーザーのtarget} | 404 not found | 高 |
| RSCH-003 | 有効計画なしで取得 | target は存在するが is_active=false | GET | 422「有効な計画が見つかりません」 | 中 |
| RSCH-004 | リスケ保存（正常） | 有効計画あり、残り学習時間あり | POST /plan-reschedule（target_id, reschedule_start_date, daily_study_time, buffer_rate, weights, no_study_days） | 200、Todo が再生成される | 高 |
| RSCH-005 | リスケ開始日が過去 | reschedule_start_date が今日以前 | POST | 422「リスケ開始日は明日以降で指定してください」 | 高 |
| RSCH-006 | リスケ開始日が試験後 | reschedule_start_date > exam_date-1 | POST | 422「リスケ開始日が試験前日を超えています」 | 中 |
| RSCH-007 | 残り時間超過でリスケ | 残り学習時間 > 再配分可能容量 | POST | 422「学習時間が不足しているためリスケジュールできません」 | 中 |
| RSCH-008 | 重みの追加・削除 | weights に既存と異なるIDを含める | POST | 422「分野の追加・削除はできません」 | 中 |

---

### 3.5 カレンダー（Calendar）

| No | テスト項目 | 前提条件 | 操作 | 期待結果 | 優先度 |
|----|-----------|----------|------|----------|--------|
| CAL-001 | 月表示イベント取得 | ログイン済み、計画あり | GET /calendar/events?start=YYYY-MM-DD&end=YYYY-MM-DD&view=dayGridMonth | 資格ごとの横棒イベントが返却 | 高 |
| CAL-002 | 週表示イベント取得 | 同上 | GET /calendar/events?start=&end=&view=timeGridWeek | 日付×資格×分野の内訳付きイベント | 高 |
| CAL-003 | start/end 未指定 | ログイン済み | GET /calendar/events（start, end なし） | バリデーションエラー または デフォルト期間で返却 | 中 |
| CAL-004 | 勉強不可日でイベント分割 | 連続日の間に不可日あり | 月表示で取得 | 不可日でイベントが分割される | 中 |

---

### 3.6 学習記録（Study Record）

| No | テスト項目 | 前提条件 | 操作 | 期待結果 | 優先度 |
|----|-----------|----------|------|----------|--------|
| REC-001 | TODO詳細取得 | ログイン済み、自分のTodo | GET /study-records/todo/{todoId} | todo_id, date, memo, qualification_name, items が返却 | 高 |
| REC-002 | 他人のTODO取得 | 他ユーザーのTodo | GET /study-records/todo/{他ユーザーのtodoId} | 404 not found | 高 |
| REC-003 | 学習記録登録（正常） | 自分のTodo、study_plan_items あり | POST /study-records（todo_id, memo, records[{study_plan_items_id, actual_minutes}]） | 200、StudyRecord が保存、is_completed が更新 | 高 |
| REC-004 | 対象外の study_plan_items_id | 他Todoの item_id を含む | POST | 422「対象外の学習項目が含まれています」 | 高 |
| REC-005 | actual_minutes >= planned_minutes で is_completed | 計画分数以上の実績 | POST | is_completed = true で保存 | 中 |
| REC-006 | メモ更新 | memo を変更して POST | Todo.memo が更新される | 中 |

---

### 3.7 学習進捗（Study Progress）

| No | テスト項目 | 前提条件 | 操作 | 期待結果 | 優先度 |
|----|-----------|----------|------|----------|--------|
| PROG-001 | 進捗ページ表示 | ログイン済み | GET /study-progress | 進捗画面が表示される | 高 |
| PROG-002 | 進捗データ取得 | ログイン済み | GET /study-progress/data | JSON で進捗データが返却 | 高 |
| PROG-003 | 管理画面から進捗表示 | 管理者ログイン | GET /admin/study-progress | 進捗画面が表示される | 中 |

---

### 3.8 管理画面（Admin）

| No | テスト項目 | 前提条件 | 操作 | 期待結果 | 優先度 |
|----|-----------|----------|------|----------|--------|
| ADM-001 | 非管理者で管理画面アクセス | 一般ユーザー | GET /admin/home | 403 または リダイレクト | 高 |
| ADM-002 | 資格一覧表示 | 管理者 | GET /admin/qualifications | 資格一覧が表示される | 高 |
| ADM-003 | 資格追加 | 管理者 | POST /admin/qualifications | 資格が作成される | 高 |
| ADM-004 | 資格更新 | 管理者 | PATCH /admin/qualifications/{id} | 資格が更新される | 高 |
| ADM-005 | 資格削除 | 管理者 | DELETE /admin/qualifications/{id} | 資格が削除される | 高 |
| ADM-006 | ドメイン追加・更新・削除 | 管理者 | POST/PATCH/DELETE /admin/domains | CRUD が正常動作 | 高 |
| ADM-007 | サブドメイン追加・更新・削除 | 管理者 | POST/PATCH/DELETE /admin/subdomains | CRUD が正常動作 | 高 |
| ADM-008 | CSVテンプレートダウンロード | 管理者 | GET /admin/qualifications/template | CSV がダウンロードされる | 中 |
| ADM-009 | 資格CSVインポート | 管理者、正しいCSV | POST /admin/qualifications/import | 資格・ドメイン・サブドメインが一括登録 | 高 |
| ADM-010 | バックアップ一覧 | 管理者 | GET /admin/backups | バックアップ一覧が表示される | 中 |
| ADM-011 | 手動バックアップ実行 | 管理者 | POST /admin/backups/manual | バックアップジョブが投入される | 中 |
| ADM-012 | ユーザー一覧・更新 | 管理者 | GET /admin/users, PUT /admin/users/{id} | 一覧表示・更新ができる | 中 |

---

### 3.9 LINE Webhook

| No | テスト項目 | 前提条件 | 操作 | 期待結果 | 優先度 |
|----|-----------|----------|------|----------|--------|
| LINE-001 | 署名不正 | - | POST /line/webhook（不正署名） | 403 | 高 |
| LINE-002 | 署名なし | - | POST /line/webhook（X-Line-Signature なし） | 403 | 高 |
| LINE-003 | events 空 | 正しい署名 | POST（events: []） | 200 | 中 |
| LINE-004 | follow イベント | 正しい署名 | POST（type: follow） | 200（現状は特にDB更新なし） | 中 |
| LINE-005 | unfollow イベント | 紐づけ済み LINE アカウント | POST（type: unfollow） | 200、line_user_id 等が null に | 高 |
| LINE-006 | 連携コードで message イベント | line_link_token が一致するユーザーがいる | POST（type: message, text: 連携コード） | 200、line_user_id 紐づけ、is_linked=true | 高 |

---

### 3.10 Cron

| No | テスト項目 | 前提条件 | 操作 | 期待結果 | 優先度 |
|----|-----------|----------|------|----------|--------|
| CRON-001 | 秘密鍵なしで実行 | - | GET /internal/cron/schedule | 403 | 高 |
| CRON-002 | 正しい秘密鍵で実行 | APP_CRON_SECRET_KEY 設定済み | GET /internal/cron/schedule?key={secret} | 200、schedule:run が実行される | 高 |
| CRON-003 | X-Cron-Secret ヘッダーで実行 | 同上 | GET（ヘッダーに秘密鍵） | 200 | 中 |

---

### 3.11 資格・ドメイン・サブドメイン（一般ユーザー）

| No | テスト項目 | 前提条件 | 操作 | 期待結果 | 優先度 |
|----|-----------|----------|------|----------|--------|
| QUAL-001 | 資格のドメイン一覧取得 | ログイン済み、資格が存在 | GET /qualifications/{id}/domains | ドメイン一覧が返却 | 高 |
| QUAL-002 | 資格のサブドメイン一覧取得 | 同上 | GET /qualifications/{id}/subdomains | サブドメイン一覧が返却 | 高 |
| QUAL-003 | 存在しない資格ID | - | GET /qualifications/99999/domains | 404 または 空配列 | 中 |

---

### 3.12 API（Sanctum）

| No | テスト項目 | 前提条件 | 操作 | 期待結果 | 優先度 |
|----|-----------|----------|------|----------|--------|
| API-001 | 認証済みで /api/user | トークン付き | GET /api/user（Bearer token） | ユーザー情報が返却 | 中 |
| API-002 | 未認証で /api/user | - | GET /api/user | 401 | 中 |

---

## 4. 境界値・エッジケース

| 対象 | ケース | 期待動作 |
|------|--------|----------|
| daily_study_time | 0 | バリデーションで弾く または 0 扱いでエラー |
| buffer_rate | 0, 100 | 0: 余裕なし、100: 全容量が余裕で計画時間0 の可能性 |
| start_date / exam_date | 同日 | 「学習期間が確保できません」 |
| no_study_days | 重複 | 一意に正規化して保存 |
| weights 合計 | 0 | リスケで「重みの合計が0です」 |
| 計画登録 | 同一資格の再登録 | 既存 target を updateOrCreate、新 plan 作成 |

---

## 5. 非機能テスト（参考）

| 項目 | 内容 |
|------|------|
| パフォーマンス | 大量 Todo・StudyPlanItem 時のカレンダー取得、進捗取得 |
| セキュリティ | CSRF、XSS、SQL インジェクション、認可チェック漏れ |
| アクセシビリティ | キーボード操作、スクリーンリーダー対応（任意） |

---

## 6. テスト環境

- PHP 8.2+
- SQLite（テスト用）または MySQL
- `.env.testing` で LINE 等をモック／無効化可能にすること推奨

---

## 7. 既存テストとの関係

プロジェクトには Jetstream 由来の以下 Feature テストが含まれています。

- `AuthenticationTest`
- `RegistrationTest`
- `EmailVerificationTest`
- `PasswordResetTest`
- `UpdatePasswordTest`
- `ProfileInformationTest`
- `DeleteAccountTest`
- など

本仕様書の認証・設定まわりは上記と重複する部分があります。必要に応じて既存テストを拡張してください。

---

## 8. 改訂履歴

| 日付 | 版 | 変更内容 |
|------|-----|----------|
| 2026-02-18 | 1.0 | 初版作成 |
